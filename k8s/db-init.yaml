apiVersion: v1
kind: ConfigMap
metadata:
  name: db-init
  namespace: cloud-demo
data:
  init.sql: |
    CREATE TABLE IF NOT EXISTS users (
        user_id TEXT PRIMARY KEY,
        username TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS public_keys (
        user_id TEXT PRIMARY KEY REFERENCES users(user_id),
        public_key TEXT NOT NULL,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS messages (
        message_id UUID PRIMARY KEY,
        sender_id TEXT REFERENCES users(user_id),
        recipient_id TEXT REFERENCES users(user_id),
        encrypted_content TEXT NOT NULL, -- The double-encrypted blob (KMS encrypted)
        encrypted_key TEXT NOT NULL,     -- The KMS encrypted data key
        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        delivered BOOLEAN DEFAULT FALSE
    );
